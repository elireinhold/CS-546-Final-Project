<h1>{{event.eventName}}</h1>

<p><strong>Borough:</strong> {{event.eventBorough}}</p>
<p><strong>Location:</strong> {{event.eventLocation}}</p>
<p><strong>Start:</strong> {{event.startDateTime}}</p>
<p><strong>End:</strong> {{event.endDateTime}}</p>

<hr>

<!-- Save Count -->
<p id="save-count-{{event._id}}">
  {{userCount}} user(s) saved this
</p>

<!-- Save / Unsave Button -->
{{#if saved}}
  <button 
    id="save-btn-{{event._id}}"
    data-event-id="{{event._id}}"
    data-saved="true"
  >
    Unsave
  </button>
{{else}}
  <button 
    id="save-btn-{{event._id}}"
    data-event-id="{{event._id}}"
    data-saved="false"
  >
    Save
  </button>
{{/if}}

<hr>

<!-- Comments Section -->
<h2>Comments</h2>
<div id="comments-container">
  {{#if event.comments}}
    {{#each event.comments}}
      <div class="comment" data-comment-id="{{this._id}}">
        <p><strong>{{this.username}}</strong> <span class="comment-date">{{this.createdAt}}</span></p>
        <p>{{this.text}}</p>
        
        {{#if ../user}}
          {{#if (eq this.userId ../user._id)}}
            <button class="delete-comment-btn" data-comment-id="{{this._id}}">Delete</button>
          {{/if}}
          <button class="reply-btn" data-comment-id="{{this._id}}">Reply</button>
        {{/if}}
        
        <!-- Replies Section -->
        <div class="replies-container" data-comment-id="{{this._id}}" style="margin-left: 20px; margin-top: 10px;">
          {{#if this.replies}}
            {{#each this.replies}}
              <div class="reply" data-reply-id="{{this._id}}">
                <p><strong>{{this.username}}</strong> <span class="reply-date">{{this.createdAt}}</span></p>
                <p>{{this.text}}</p>
              </div>
            {{/each}}
          {{/if}}
        </div>
        
        <!-- Reply Form (hidden by default) -->
        {{#if ../user}}
          <div class="reply-form-container" data-comment-id="{{this._id}}" style="display: none; margin-left: 20px; margin-top: 10px;">
            <textarea class="reply-text" rows="3" cols="40" placeholder="Write your reply..."></textarea>
            <br>
            <button class="submit-reply-btn" data-comment-id="{{this._id}}">Submit Reply</button>
            <button class="cancel-reply-btn" data-comment-id="{{this._id}}">Cancel</button>
          </div>
        {{/if}}
      </div>
    {{/each}}
  {{else}}
    <p>No comments yet.</p>
  {{/if}}
</div>

{{#if user}}
  <div id="add-comment-section">
    <h3>Add a Comment</h3>
    <textarea id="comment-text" rows="4" cols="50" placeholder="Write your comment here..."></textarea>
    <br>
    <button id="submit-comment-btn">Submit Comment</button>
  </div>
{{else}}
  <p><a href="/users/login">Login</a> to add a comment.</p>
{{/if}}

<hr>

<a id="back-link" href="{{returnTo}}">‚Üê Back to Results</a>

<script>
  const returnTo = "{{returnTo}}";
  const eventId = "{{event._id}}";
  // Prefer actual previous page; fall back to returnTo; default to search
  const backLink = document.getElementById("back-link");
  const fallback = returnTo || "/events/search";
  const target = document.referrer && document.referrer !== window.location.href
    ? document.referrer
    : fallback;
  backLink.setAttribute("href", target);
  backLink.addEventListener("click", (e) => {
    e.preventDefault();
    window.location.href = target;
  });
</script>
<script src="/public/js/eventDetails.js"></script>