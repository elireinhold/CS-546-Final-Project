<!-- Two-column container -->
<div class="flex-container">
  <!-- Left column: event details + comments -->
  <div class="left-side">
    <h1>{{event.eventName}}</h1>
    {{#if ownEvent}}
    <div class="creator-controls">
      <button id="edit">Edit</button>
      <button id="delete">Delete</button>
    </div>
    {{/if}}
    <p><strong>Type:</strong> {{event.eventType}}</p>
    <p><strong>Borough:</strong> {{event.eventBorough}}</p>
    <p><strong>Location:</strong> {{event.eventLocation}}</p>
    <p><strong>Road Closure:</strong> 
      {{#if event.streetClosureType}}
        {{event.streetClosureType}}
      {{else}}
        N/A
      {{/if}}
    </p>
    <p><strong>Source:</strong> 
    {{event.eventSource}}
    {{#if creatorId}}
      <a id="profile-button" href="/users/{{creatorId}}/profile">(profile)</a>
    {{/if}}
    </p>
    <p><strong>Start:</strong> {{event.startDateTimeLocal}}</p>
    <p><strong>End:</strong> {{event.endDateTimeLocal}}</p>

    <!-- Inline saved count + save button -->
    <div class="save-row">
      <p id="save-count-{{event._id}}">
        {{userCount}} User(s) Saved This
      </p>

      {{#if saved}}
        <button 
          id="save-btn-{{event._id}}"
          data-event-id="{{event._id}}"
          data-saved="true"
        >
          Unsave
        </button>
      {{else}}
        <button 
          id="save-btn-{{event._id}}"
          data-event-id="{{event._id}}"
          data-saved="false"
        >
          Save
        </button>
      {{/if}}
    </div>

    <!-- Share button -->
    <div class="share-row">
      <button id="share-btn-{{event._id}}" data-event-id="{{event._id}}">
        Share
      </button>
      <span id="share-message-{{event._id}}" class="share-message" style="display: none;">
        Link copied. Send it to your friend now
      </span>
    </div>

    <!-- Comments section directly under save button -->
    <div id="comments-section">
      <hr>
      <h2>Comments</h2>
      <div id="comments-container">
        <div id="comments-list">
          {{#if event.comments}}
            {{#each event.comments}}
              <div class="comment">
                <strong>{{this.username}}:</strong> {{this.text}}
              </div>
            {{/each}}
          {{else}}
            <p>No comments yet.</p>
          {{/if}}
        </div>
      </div>

      {{#if user}}
        <div id="add-comment-section">
          <h3>Add a Comment</h3>
          <textarea id="comment-text" rows="4" cols="50" placeholder="Write your comment here..."></textarea>
          <br>
          <button id="submit-comment-btn">Submit Comment</button>
        </div>
      {{else}}
        <p><a href="/users/login">Login</a> to add a comment.</p>
      {{/if}}
    </div>
  </div>

  <!-- Right column: map -->
  <div class="right-side">
    <h2>Event Location</h2>
    <div id="map"></div>
  </div>
</div>

<hr>
<a id="back-link" href="{{returnTo}}">‚Üê Back to Results</a>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/geolib@3.3.4/lib/index.min.js"></script>
<script>
  const eventLocation = {{{json eventLocation}}};
  const ownEvent = {{ownEvent}};
</script>
<script src="/public/js/eventMap.js"></script>
<script type="module" src="/public/js/eventDetails.js"></script>

<script>
  const returnTo = "{{returnTo}}";
  const eventId = "{{event._id}}";
  const currentUserId = {{#if user}}"{{user._id}}"{{else}}null{{/if}};
  const currentUsername = {{#if user}}"{{user.username}}"{{else}}null{{/if}};
  const allComments = {{#if event.comments}}{{{json event.comments}}}{{else}}[]{{/if}};

  // Handle back link
  const backLink = document.getElementById("back-link");
  const fallback = returnTo || "/events/search";
  const target = window.document.referrer && window.document.referrer !== window.location.href
    ? window.document.referrer
    : fallback;
  backLink.setAttribute("href", target);
  backLink.addEventListener("click", (e) => {
    e.preventDefault();
    window.location.href = target;
  });
</script>

<!-- input type="hidden" value="{{hasOwn}}" id="hasOwnPassthrough"-->
